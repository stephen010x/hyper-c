local build = require "buildtree"


buildtree = newbuildtree()

local dir = {
    src = "src",
    tmp = "tmp",
    inc = "inc",
    bin = "bin",
}

local target = "main.exe"
local srcdir = "src"
local bindir = "bin"
local options = "-d -Os -DDEBUG"

-- recursively searches through srcdir for C files, and adds them to the build tree
local objects = buildtree:rfilltree(srcdir, bindir, ext.c, options)

local targpath = bindir.."/"..target

-- add some custom options to the linker stage
buildtree.targets[targpath].options:insert("-fPIC")
-- set the dependancies of the linker stage
buildtree.targets[targpath].depends:append(objects)


-- describes the known types, and what compiler is used to compile them
buildtree.types = {
  [ext.exe] = gcc_builder(ext.exe)
  [ext.object] = gcc_builder(ext.object)
  filetype = default.filetype -- callback to detect file types
}

buildtree:build(targpath)




-- another idea is to just have a function that recursively pulls in
-- all known dependancies. Like you build part of the tree, and then let
-- the build dependancy function do the rest.
















-- describes the known types, and what compiler is used to compile them
typemap = {
  
  -- describes to build system how to build exe
  [ext.exe] = {
    builder = function(path, infiles, opts)
      cmd("gcc -o "..path.." "..tostring(infiles).." "..opts)
    end
  },

  -- describes to build system how to build object
  [ext.object] = {
    builder = function(path, infiles, opts)
      cmd("gcc -c -o "..path.." "..tostring(infiles).." "..opts)
    end
  },
  filetype = default.filetype -- callback
}

-- the build tree
-- describes all generated files, and links all of their dependancies
-- uses the type of the targets and the typetable to build each file
buildtree = newbuildtree()
buildtree.typemap = typemap

buildtree.targets = {
    ["bin/main.exe"] = {
        btype = ext.exe,
        depends = { "tmp/main.o", },
        options = "-d -Os -fPIC",
        force_rebuild = false,
    },

    ["tmp/main.o"] = {
        btype = ext.o,
        depends = { "src/main.c", "inc/main.h" },
        options = "-d -Os -DDEBUG",
        force_rebuild = false,
    },
}

buildtree:build("bin/main.exe")










typemap = newtypemap()
typemap[ext.exe] = newtype()
typemap[ext.o] = newtype()

typemap[ext.exe].builder = function(path, infiles, opts)
    cmd("gcc -o "..path.." "..tostring(infiles).." "..opts)
end










local function defmode()
    return {type = {}, file = {}}
end


local function deftype()
    return {builder = {}, options = {}}
end


local gopts = {
    all = newmode(),
    
    -- register = function(self, mode) {
    --     if type(t) ~= "table" then mode = {mode} end
    --     
    --     for key, value in pairs(t) do
    --         self[value] = {type = {}, file = {}}
    --     end
    -- }
}


gopts.fast    = defmode()
gopts.debug   = defmode()
gopts.release = defmode()


gopts.all.type[ext.c] = deftype()




-- for every file being compiled in our entire dependancy tree, what do we
-- ultimately need?
-- inputs, outputs, options, compiler

-- I need a descriptor that can specify global options per type, while also
-- 

--[[
Heiarchy:
desc
    all
        type
            [typename]
                *desc*
                    
        file
            [typename]
                *desc*
    [modes]
        type
                [typename]
                    *desc*
                    
        file
                [typename]
                    *desc*
]]--


--[[
Heiarchy:
desc
    [modes]
        type[typenames]
            global
                *desc*
            local
                [filename]
                    *desc*
]]--
